import React, { useState, useEffect } from 'react';
import { Trophy, BookOpen, Sword, ShoppingCart, BarChart3, Save, LogOut, Star, Coins, Zap, Shield, Target, ChevronRight, Award, Crown } from 'lucide-react';

const ChemistryRPG = () => {
  // åˆå§‹ç©å®¶æ•¸æ“š
  const initialPlayer = {
    name: "è¦‹ç¿’åŒ–å­¸å®¶",
    level: 1,
    exp: 0,
    exp_to_next: 100,
    coins: 50,
    attack: 10,
    defense: 5,
    accuracy: 60,
    skill_points: 0,
    title: "åŒ–å­¸å­¸å¾’",
    equipment: {},
    achievements: [],
    topics_completed: [],
    bosses_defeated: [],
    daily_streak: 0,
    total_questions: 0,
    correct_answers: 0
  };

  // èª²é¡Œæ•¸æ“š
  const initialTopics = {
    "1": { name: "åœ°çƒè³‡æº", icon: "ğŸŒ", progress: 0, total: 5 },
    "2": { name: "å¾®è§€ä¸–ç•Œ", icon: "âš›ï¸", progress: 0, total: 5 },
    "3": { name: "é‡‘å±¬", icon: "ğŸ’", progress: 0, total: 5 },
    "4": { name: "é…¸é¹¼é¹½", icon: "ğŸ§ª", progress: 0, total: 5 },
    "5": { name: "åŒ–çŸ³ç‡ƒæ–™", icon: "â›½", progress: 0, total: 5 },
    "6": { name: "æ°§åŒ–é‚„åŸåæ‡‰", icon: "ğŸ”‹", progress: 0, total: 5 },
    "7": { name: "åŒ–å­¸åæ‡‰èˆ‡èƒ½é‡", icon: "âš¡", progress: 0, total: 5 },
    "8": { name: "åæ‡‰é€Ÿç‡èˆ‡å¹³è¡¡", icon: "âš–ï¸", progress: 0, total: 5 },
    "9": { name: "åŒ–å­¸ä¸–ç•Œä¸­çš„è¦å¾‹", icon: "ğŸ“Š", progress: 0, total: 5 }
  };

  // é­”ç‹æ•¸æ“š
  const initialBosses = {
    "U": { name: "æ··æ²Œä¹‹æº", level: "U", defeated: false, hp: 100, difficulty: 1 },
    "1": { name: "æ¨¡ç³Šä¹‹å½±", level: "1", defeated: false, hp: 150, difficulty: 2 },
    "2": { name: "çµæ§‹ä¹‹æƒ‘", level: "2", defeated: false, hp: 200, difficulty: 3 },
    "3": { name: "è®ŠåŒ–ä¹‹å¾‹", level: "3", defeated: false, hp: 250, difficulty: 4 },
    "4": { name: "åˆ†æä¹‹çœ¼", level: "4", defeated: false, hp: 300, difficulty: 5 },
    "5": { name: "ç¶œåˆä¹‹ç¶²", level: "5", defeated: false, hp: 400, difficulty: 6 },
    "5*": { name: "ç²¾é€šä¹‹å·”", level: "5*", defeated: false, hp: 500, difficulty: 7 },
    "5**": { name: "å‰µæ–°ä¹‹å·”", level: "5**", defeated: false, hp: 600, difficulty: 8 }
  };

  // è£å‚™å•†åº—
  const equipmentShop = {
    "ç²¾å¯†æ»´å®šç®¡": { price: 100, attack: 8, accuracy: 5, description: "+8æ”»æ“ŠåŠ›, +5%å¯¦é©—ç²¾åº¦" },
    "é«˜æ•ˆæœ¬ç”Ÿç‡ˆ": { price: 150, attack: 12, description: "+12æ”»æ“ŠåŠ›, åŠ é€Ÿåæ‡‰ä»»å‹™" },
    "é›»è§£å¤§å¸«æ‰‹å¥—": { price: 200, attack: 15, defense: 10, description: "+15æ”»æ“ŠåŠ›, +10é˜²ç¦¦åŠ›" },
    "åŒ–å­¸å…¸ç±": { price: 120, defense: 10, accuracy: 8, description: "+10é˜²ç¦¦åŠ›, æå‡ç†è«–é¡Œå¾—åˆ†" },
    "è­·ç›®é¡": { price: 80, defense: 5, accuracy: 10, description: "+5é˜²ç¦¦åŠ›, +10%å¯¦é©—ç²¾åº¦" },
    "è¨ˆç®—ç¥å™¨": { price: 250, attack: 20, accuracy: 15, description: "+20æ”»æ“ŠåŠ›, +15%è¨ˆç®—æº–ç¢ºåº¦" }
  };

  // æˆå°±ç³»çµ±
  const initialAchievements = {
    "é›»è§£å¤§å¸«": { description: "å®Œæˆ10å€‹é›»è§£ç›¸é—œé¡Œç›®", reward: 50, unlocked: false },
    "è¨ˆç®—é”äºº": { description: "é€£çºŒ10é¡Œè¨ˆç®—å…¨å°", reward: 100, unlocked: false },
    "å¯¦é©—é›¶å¤±èª¤": { description: "å®Œæˆæ‰€æœ‰å¯¦é©—æ¨¡æ“¬ç„¡éŒ¯èª¤", reward: 200, unlocked: false },
    "ç™¾é¡Œæ–¬": { description: "å›ç­”100é“é¡Œç›®", reward: 150, unlocked: false },
    "çŸ¥è­˜æ”¶é›†è€…": { description: "å®Œæˆ5å€‹èª²é¡Œ", reward: 300, unlocked: false },
    "é­”ç‹çµ‚çµè€…": { description: "æ“Šæ•—æ‰€æœ‰çŸ¥è­˜é­”ç‹", reward: 500, unlocked: false },
    "å®Œç¾ä¸»ç¾©è€…": { description: "ç­”é¡Œæº–ç¢ºç‡é”åˆ°90%", reward: 250, unlocked: false }
  };

  // é¡Œåº«
  const questionBank = {
    "1": [
      {
        question: "éµç¤¦çŸ³ä¸»è¦ç”¨å“ªç¨®æ–¹æ³•æå–éµï¼Ÿ",
        options: ["A. é›»è§£", "B. ç¢³é‚„åŸ", "C. ç†±åˆ†è§£", "D. ç‰©ç†åˆ†é›¢"],
        answer: "B",
        explanation: "éµç¤¦çŸ³é€šå¸¸ä½¿ç”¨ç¢³é‚„åŸæ³•æå–éµï¼Œåœ¨é«˜æº«ä¸‹ç”¨ä¸€æ°§åŒ–ç¢³é‚„åŸæ°§åŒ–éµã€‚",
        topic: "é‡‘å±¬æå–",
        difficulty: 2
      },
      {
        question: "ä»¥ä¸‹å“ªç¨®æ°£é«”æœƒå°è‡´æº«å®¤æ•ˆæ‡‰ï¼Ÿ",
        options: ["A. æ°§æ°£", "B. æ°®æ°£", "C. äºŒæ°§åŒ–ç¢³", "D. æ°«æ°£"],
        answer: "C",
        explanation: "äºŒæ°§åŒ–ç¢³æ˜¯ä¸»è¦çš„æº«å®¤æ°£é«”ä¹‹ä¸€ï¼Œèƒ½å¸æ”¶åœ°é¢è¼»å°„çš„ç´…å¤–ç·šã€‚",
        topic: "ç’°å¢ƒåŒ–å­¸",
        difficulty: 1
      },
      {
        question: "çŸ³ç°çŸ³çš„ä¸»è¦æˆåˆ†æ˜¯ä»€éº¼ï¼Ÿ",
        options: ["A. CaO", "B. CaCOâ‚ƒ", "C. Ca(OH)â‚‚", "D. CaSOâ‚„"],
        answer: "B",
        explanation: "çŸ³ç°çŸ³çš„ä¸»è¦æˆåˆ†æ˜¯ç¢³é…¸éˆ£(CaCOâ‚ƒ)ã€‚",
        topic: "ç¤¦ç‰©",
        difficulty: 1
      },
      {
        question: "ç…¤ç‚­ç‡ƒç‡’æœƒç”¢ç”Ÿå“ªç¨®æœ‰å®³æ°£é«”ï¼Ÿ",
        options: ["A. Oâ‚‚", "B. Nâ‚‚", "C. SOâ‚‚", "D. Hâ‚‚"],
        answer: "C",
        explanation: "ç…¤ç‚­å«æœ‰ç¡«åŒ–åˆç‰©ï¼Œç‡ƒç‡’æ™‚æœƒç”¢ç”ŸäºŒæ°§åŒ–ç¡«ï¼Œå°è‡´é…¸é›¨ã€‚",
        topic: "ç‡ƒæ–™åŒ–å­¸",
        difficulty: 2
      },
      {
        question: "æµ·æ°´ä¸­å«é‡æœ€å¤šçš„é¹½é¡æ˜¯ï¼Ÿ",
        options: ["A. NaCl", "B. MgClâ‚‚", "C. CaClâ‚‚", "D. KCl"],
        answer: "A",
        explanation: "æµ·æ°´ä¸­å«é‡æœ€å¤šçš„é¹½é¡æ˜¯æ°¯åŒ–éˆ‰(NaCl)ï¼Œç´„ä½”ç¸½é¹½åˆ†çš„77%ã€‚",
        topic: "å¤©ç„¶è³‡æº",
        difficulty: 2
      }
    ],
    "2": [
      {
        question: "åŸå­æ ¸ç”±ä»€éº¼ç²’å­çµ„æˆï¼Ÿ",
        options: ["A. è³ªå­å’Œé›»å­", "B. è³ªå­å’Œä¸­å­", "C. ä¸­å­å’Œé›»å­", "D. åªæœ‰è³ªå­"],
        answer: "B",
        explanation: "åŸå­æ ¸ç”±è³ªå­å’Œä¸­å­çµ„æˆï¼Œé›»å­åœ¨æ ¸å¤–é‹å‹•ã€‚",
        topic: "åŸå­çµæ§‹",
        difficulty: 1
      },
      {
        question: "ç¢³-12åŸå­çš„è³ªé‡æ•¸æ˜¯å¤šå°‘ï¼Ÿ",
        options: ["A. 6", "B. 12", "C. 18", "D. 24"],
        answer: "B",
        explanation: "è³ªé‡æ•¸ç­‰æ–¼è³ªå­æ•¸åŠ ä¸­å­æ•¸ï¼Œç¢³-12æœ‰6å€‹è³ªå­å’Œ6å€‹ä¸­å­ã€‚",
        topic: "åŸå­è³ªé‡",
        difficulty: 2
      }
    ],
    "3": [
      {
        question: "é‡‘å±¬å…·æœ‰å…‰æ¾¤æ˜¯å› ç‚ºï¼Ÿ",
        options: ["A. é›»å­é›²åå°„å…‰ç·š", "B. åŸå­æŒ¯å‹•", "C. é›¢å­æ’åˆ—", "D. åŒ–å­¸åæ‡‰"],
        answer: "A",
        explanation: "é‡‘å±¬çš„è‡ªç”±é›»å­èƒ½æœ‰æ•ˆåå°„å…‰ç·šï¼Œå› æ­¤å…·æœ‰é‡‘å±¬å…‰æ¾¤ã€‚",
        topic: "é‡‘å±¬æ€§è³ª",
        difficulty: 2
      },
      {
        question: "é‹åœ¨ç©ºæ°£ä¸­ä¸æ˜“è…è•æ˜¯å› ç‚ºï¼Ÿ",
        options: ["A. é‹å¾ˆç©©å®š", "B. è¡¨é¢å½¢æˆæ°§åŒ–è†œ", "C. é‹ä¸æ´»æ½‘", "D. é‹ä¸å°é›»"],
        answer: "B",
        explanation: "é‹è¡¨é¢æœƒå½¢æˆç·»å¯†çš„æ°§åŒ–é‹è–„è†œï¼Œé˜»æ­¢é€²ä¸€æ­¥æ°§åŒ–ã€‚",
        topic: "é‡‘å±¬è…è•",
        difficulty: 2
      }
    ],
    "4": [
      {
        question: "ä»¥ä¸‹å“ªç¨®ç‰©è³ªæ˜¯å¼·é…¸ï¼Ÿ",
        options: ["A. é†‹é…¸", "B. ç¡«é…¸", "C. ç¢³é…¸", "D. ç¡¼é…¸"],
        answer: "B",
        explanation: "ç¡«é…¸æ˜¯å¸¸è¦‹çš„å¼·é…¸ï¼Œåœ¨æ°´ä¸­å®Œå…¨é›»é›¢ã€‚",
        topic: "é…¸çš„å¼·åº¦",
        difficulty: 1
      },
      {
        question: "pHå€¼ç‚º7çš„æº¶æ¶²æ˜¯ï¼Ÿ",
        options: ["A. é…¸æ€§", "B. é¹¼æ€§", "C. ä¸­æ€§", "D. ç„¡æ³•ç¢ºå®š"],
        answer: "C",
        explanation: "pH=7è¡¨ç¤º[Hâº]=[OHâ»]ï¼Œæº¶æ¶²å‘ˆä¸­æ€§ã€‚",
        topic: "pHå€¼",
        difficulty: 1
      }
    ]
  };

  // ç‹€æ…‹ç®¡ç†
  const [player, setPlayer] = useState(initialPlayer);
  const [topics, setTopics] = useState(initialTopics);
  const [bosses, setBosses] = useState(initialBosses);
  const [achievements, setAchievements] = useState(initialAchievements);
  const [currentView, setCurrentView] = useState('main');
  const [currentChallenge, setCurrentChallenge] = useState(null);
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState('');
  const [showResult, setShowResult] = useState(false);
  const [challengeQuestions, setChallengeQuestions] = useState([]);
  const [challengeResults, setChallengeResults] = useState({ correct: 0, total: 0 });
  const [message, setMessage] = useState('');

  // è¼‰å…¥éŠæˆ²æ•¸æ“š
  useEffect(() => {
    const savedGame = localStorage.getItem('dse-chemistry-rpg');
    if (savedGame) {
      try {
        const gameData = JSON.parse(savedGame);
        setPlayer(gameData.player || initialPlayer);
        setTopics(gameData.topics || initialTopics);
        setBosses(gameData.bosses || initialBosses);
        setAchievements(gameData.achievements || initialAchievements);
      } catch (e) {
        console.error('è¼‰å…¥éŠæˆ²å¤±æ•—:', e);
      }
    }
  }, []);

  // å„²å­˜éŠæˆ²
  const saveGame = () => {
    const gameData = {
      player,
      topics,
      bosses,
      achievements,
      lastSave: new Date().toISOString()
    };
    localStorage.setItem('dse-chemistry-rpg', JSON.stringify(gameData));
    setMessage('âœ… éŠæˆ²é€²åº¦å·²å„²å­˜ï¼');
    setTimeout(() => setMessage(''), 3000);
  };

  // å‡ç´šæª¢æŸ¥
  const checkLevelUp = (newPlayer) => {
    let updatedPlayer = { ...newPlayer };
    
    while (updatedPlayer.exp >= updatedPlayer.exp_to_next) {
      updatedPlayer.exp -= updatedPlayer.exp_to_next;
      updatedPlayer.level += 1;
      updatedPlayer.exp_to_next = Math.floor(updatedPlayer.exp_to_next * 1.5);
      updatedPlayer.attack += 5;
      updatedPlayer.defense += 3;
      updatedPlayer.accuracy += 2;
      updatedPlayer.skill_points += 1;
      
      // æ›´æ–°ç¨±è™Ÿ
      if (updatedPlayer.level >= 20) updatedPlayer.title = "å‚³å¥‡ç…‰é‡‘å¸«";
      else if (updatedPlayer.level >= 15) updatedPlayer.title = "å…ƒç´ æŒæ§è€…";
      else if (updatedPlayer.level >= 10) updatedPlayer.title = "å‚‘å‡ºåˆ†æè€…";
      else if (updatedPlayer.level >= 5) updatedPlayer.title = "åˆæ ¼å¯¦é©—å“¡";
      
      setMessage(`ğŸ‰ æ­å–œå‡ç´šåˆ° ${updatedPlayer.level} ç´šï¼ç²å¾—æŠ€èƒ½é» +1`);
    }
    
    return updatedPlayer;
  };

  // æª¢æŸ¥æˆå°±
  const checkAchievements = (newPlayer) => {
    let updatedAchievements = { ...achievements };
    let newUnlocked = [];
    
    // ç™¾é¡Œæ–¬
    if (newPlayer.total_questions >= 100 && !updatedAchievements['ç™¾é¡Œæ–¬'].unlocked) {
      updatedAchievements['ç™¾é¡Œæ–¬'].unlocked = true;
      newUnlocked.push('ç™¾é¡Œæ–¬');
    }
    
    // å®Œç¾ä¸»ç¾©è€…
    if (newPlayer.total_questions >= 20 && 
        (newPlayer.correct_answers / newPlayer.total_questions) >= 0.9 &&
        !updatedAchievements['å®Œç¾ä¸»ç¾©è€…'].unlocked) {
      updatedAchievements['å®Œç¾ä¸»ç¾©è€…'].unlocked = true;
      newUnlocked.push('å®Œç¾ä¸»ç¾©è€…');
    }
    
    // è™•ç†æ–°æˆå°±çå‹µ
    if (newUnlocked.length > 0) {
      let totalReward = 0;
      newUnlocked.forEach(achievement => {
        totalReward += updatedAchievements[achievement].reward;
      });
      newPlayer.coins += totalReward;
      setMessage(`ğŸ† ç²å¾—æˆå°±ï¼š${newUnlocked.join('ã€')}ï¼çå‹µ ${totalReward} é‡‘å¹£`);
    }
    
    setAchievements(updatedAchievements);
    return newPlayer;
  };

  // é–‹å§‹èª²é¡ŒæŒ‘æˆ°
  const startTopicChallenge = (topicId) => {
    const questions = questionBank[topicId] || [];
    setChallengeQuestions(questions);
    setCurrentChallenge(topicId);
    setCurrentQuestion(0);
    setSelectedAnswer('');
    setShowResult(false);
    setChallengeResults({ correct: 0, total: questions.length });
    setCurrentView('challenge');
  };

  // æäº¤ç­”æ¡ˆ
  const submitAnswer = () => {
    if (!selectedAnswer) return;
    
    const question = challengeQuestions[currentQuestion];
    const isCorrect = selectedAnswer === question.answer;
    
    let newPlayer = { ...player };
    newPlayer.total_questions += 1;
    
    if (isCorrect) {
      newPlayer.correct_answers += 1;
      const expGain = question.difficulty * 10;
      const coinGain = question.difficulty * 2;
      newPlayer.exp += expGain;
      newPlayer.coins += coinGain;
      setChallengeResults(prev => ({ ...prev, correct: prev.correct + 1 }));
    }
    
    newPlayer = checkLevelUp(newPlayer);
    newPlayer = checkAchievements(newPlayer);
    setPlayer(newPlayer);
    setShowResult(true);
  };

  // ä¸‹ä¸€é¡Œ
  const nextQuestion = () => {
    if (currentQuestion < challengeQuestions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      setSelectedAnswer('');
      setShowResult(false);
    } else {
      // æŒ‘æˆ°å®Œæˆ
      const topicId = currentChallenge;
      const newTopics = { ...topics };
      newTopics[topicId].progress = Math.min(
        newTopics[topicId].progress + challengeResults.correct,
        newTopics[topicId].total
      );
      setTopics(newTopics);
      
      const accuracy = (challengeResults.correct / challengeResults.total) * 100;
      if (accuracy >= 80) {
        const bonusExp = 50;
        const bonusCoins = 20;
        let newPlayer = { ...player };
        newPlayer.exp += bonusExp;
        newPlayer.coins += bonusCoins;
        newPlayer = checkLevelUp(newPlayer);
        setPlayer(newPlayer);
        setMessage(`ğŸ‰ å„ªç§€è¡¨ç¾çå‹µï¼š${bonusExp} ç¶“é©—å€¼ï¼Œ${bonusCoins} é‡‘å¹£`);
      }
      
      setCurrentView('main');
    }
  };

  // è³¼è²·è£å‚™
  const buyEquipment = (itemName, itemData) => {
    if (player.coins >= itemData.price && !player.equipment[itemName]) {
      let newPlayer = { ...player };
      newPlayer.coins -= itemData.price;
      newPlayer.equipment[itemName] = itemData;
      
      if (itemData.attack) newPlayer.attack += itemData.attack;
      if (itemData.defense) newPlayer.defense += itemData.defense;
      if (itemData.accuracy) newPlayer.accuracy += itemData.accuracy;
      
      setPlayer(newPlayer);
      setMessage(`âœ… æˆåŠŸè³¼è²· ${itemName}ï¼`);
      setTimeout(() => setMessage(''), 3000);
    } else if (player.equipment[itemName]) {
      setMessage('âŒ ä½ å·²ç¶“æ“æœ‰é€™ä»¶è£å‚™äº†ï¼');
      setTimeout(() => setMessage(''), 3000);
    } else {
      setMessage('âŒ é‡‘å¹£ä¸è¶³ï¼');
      setTimeout(() => setMessage(''), 3000);
    }
  };

  // é€²åº¦æ¢çµ„ä»¶
  const ProgressBar = ({ current, max, className = '' }) => {
    const percentage = (current / max) * 100;
    return (
      <div className={`w-full bg-gray-200 rounded-full h-2 ${className}`}>
        <div 
          className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
          style={{ width: `${percentage}%` }}
        />
      </div>
    );
  };

  // ä¸»ç•Œé¢æ¸²æŸ“
  const renderMainView = () => (
    <div className="space-y-6">
      {/* ç©å®¶ç‹€æ…‹å¡ç‰‡ */}
      <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-lg shadow-lg">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h2 className="text-2xl font-bold">{player.name}</h2>
            <p className="text-blue-100">{player.title}</p>
          </div>
          <div className="text-right">
            <div className="flex items-center gap-2 mb-1">
              <Crown className="w-5 h-5" />
              <span className="text-xl font-bold">ç­‰ç´š {player.level}</span>
            </div>
            <div className="flex items-center gap-2">
              <Coins className="w-4 h-4" />
              <span>{player.coins} é‡‘å¹£</span>
            </div>
          </div>
        </div>
        
        <div className="grid grid-cols-3 gap-4 mb-4">
          <div className="text-center">
            <div className="flex items-center justify-center gap-1 mb-1">
              <Sword className="w-4 h-4" />
              <span className="font-medium">æ”»æ“ŠåŠ›</span>
            </div>
            <span className="text-lg font-bold">{player.attack}</span>
          </div>
          <div className="text-center">
            <div className="flex items-center justify-center gap-1 mb-1">
              <Shield className="w-4 h-4" />
              <span className="font-medium">é˜²ç¦¦åŠ›</span>
            </div>
            <span className="text-lg font-bold">{player.defense}</span>
          </div>
          <div className="text-center">
            <div className="flex items-center justify-center gap-1 mb-1">
              <Target className="w-4 h-4" />
              <span className="font-medium">ç²¾åº¦</span>
            </div>
            <span className="text-lg font-bold">{player.accuracy}%</span>
          </div>
        </div>
        
        <div className="space-y-2">
          <div className="flex justify-between text-sm">
            <span>ç¶“é©—å€¼</span>
            <span>{player.exp}/{player.exp_to_next}</span>
          </div>
          <ProgressBar current={player.exp} max={player.exp_to_next} />
        </div>
        
        {player.total_questions > 0 && (
          <div className="mt-4 text-center">
            <span className="text-blue-100">
              ç­”é¡Œæº–ç¢ºç‡: {((player.correct_answers / player.total_questions) * 100).toFixed(1)}% 
              ({player.correct_answers}/{player.total_questions})
            </span>
          </div>
        )}
      </div>

      {/* ä¸»é¸å–®æŒ‰éˆ• */}
      <div className="grid grid-cols-2 gap-4">
        <button
          onClick={() => setCurrentView('topics')}
          className="flex items-center justify-between p-4 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors"
        >
          <div className="flex items-center gap-3">
            <BookOpen className="w-6 h-6" />
            <span className="font-medium">èª²é¡ŒæŒ‘æˆ°</span>
          </div>
          <ChevronRight className="w-5 h-5" />
        </button>
        
        <button
          onClick={() => setCurrentView('bosses')}
          className="flex items-center justify-between p-4 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors"
        >
          <div className="flex items-center gap-3">
            <Sword className="w-6 h-6" />
            <span className="font-medium">é­”ç‹æŒ‘æˆ°</span>
          </div>
          <ChevronRight className="w-5 h-5" />
        </button>
        
        <button
          onClick={() => setCurrentView('shop')}
          className="flex items-center justify-between p-4 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors"
        >
          <div className="flex items-center gap-3">
            <ShoppingCart className="w-6 h-6" />
            <span className="font-medium">è£å‚™å•†åº—</span>
          </div>
          <ChevronRight className="w-5 h-5" />
        </button>
        
        <button
          onClick={() => setCurrentView('achievements')}
          className="flex items-center justify-between p-4 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors"
        >
          <div className="flex items-center gap-3">
            <Trophy className="w-6 h-6" />
            <span className="font-medium">æˆå°±ç³»çµ±</span>
          </div>
          <ChevronRight className="w-5 h-5" />
        </button>
        
        <button
          onClick={() => setCurrentView('report')}
          className="flex items-center justify-between p-4 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
        >
          <div className="flex items-center gap-3">
            <BarChart3 className="w-6 h-6" />
            <span className="font-medium">å­¸ç¿’å ±å‘Š</span>
          </div>
          <ChevronRight className="w-5 h-5" />
        </button>
        
        <button
          onClick={saveGame}
          className="flex items-center justify-between p-4 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors"
        >
          <div className="flex items-center gap-3">
            <Save className="w-6 h-6" />
            <span className="font-medium">å„²å­˜éŠæˆ²</span>
          </div>
          <ChevronRight className="w-5 h-5" />
        </button>
      </div>
    </div>
  );

  // èª²é¡Œé¸å–®
  const renderTopicsView = () => (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold">ğŸ¯ DSEåŒ–å­¸èª²é¡ŒæŒ‘æˆ°</h2>
        <button
          onClick={() => setCurrentView('main')}
          className="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"
        >
          è¿”å›ä¸»é¸å–®
        </button>
      </div>
      
      <div className="grid gap-4">
        {Object.entries(topics).map(([topicId, topic]) => (
          <div key={topicId} className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-3">
                <span className="text-2xl">{topic.icon}</span>
                <div>
                  <h3 className="font-medium">{topic.name}</h3>
                  <p className="text-sm text-gray-600">
                    é€²åº¦: {topic.progress}/{topic.total}
                    {topic.progress >= topic.total && " âœ…å·²å®Œæˆ"}
                  </p>
                </div>
              </div>
              <button
                onClick={() => startTopicChallenge(topicId)}
                disabled={!questionBank[topicId]}
                className="px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors"
              >
                é–‹å§‹æŒ‘æˆ°
              </button>
            </div>
            <ProgressBar current={topic.progress} max={topic.total} />
          </div>
        ))}
      </div>
    </div>
  );

  // æŒ‘æˆ°ç•Œé¢
  const renderChallengeView = () => {
    if (!challengeQuestions.length) return <div>è¼‰å…¥ä¸­...</div>;
    
    const question = challengeQuestions[currentQuestion];
    
    return (
      <div className="max-w-2xl mx-auto space-y-6">
        <div className="flex items-center justify-between">
          <h2 className="text-xl font-bold">
            {topics[currentChallenge]?.icon} {topics[currentChallenge]?.name}
          </h2>
          <span className="text-sm text-gray-600">
            {currentQuestion + 1}/{challengeQuestions.length}
          </span>
        </div>
        
        <div className="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
          <div className="mb-4">
            <div className="flex items-center gap-2 mb-2">
              <span className="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                {question.topic}
              </span>
              <span className="text-sm bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                é›£åº¦: {'â­'.repeat(question.difficulty)}
              </span>
            </div>
            <h3 className="text-lg font-medium mb-4">{question.question}</h3>
          </div>
          
          <div className="space-y-3 mb-6">
            {question.options.map((option, index) => (
              <label key={index} className="flex items-center space-x-3 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50">
                <input
                  type="radio"
                  name="answer"
                  value={option.charAt(0)}
                  checked={selectedAnswer === option.charAt(0)}
                  onChange={(e) => setSelectedAnswer(e.target.value)}
                  disabled={showResult}
                  className="w-4 h-4 text-blue-600"
                />
                <span className={`flex-1 ${showResult && option.charAt(0) === question.answer ? 'text-green-600 font-medium' : ''}`}>
                  {option}
                </span>
                {showResult && option.charAt(0) === question.answer && (
                  <span className="text-green-600">âœ“</span>
                )}
                {showResult && option.charAt(0) === selectedAnswer && selectedAnswer !== question.answer && (
                  <span className="text-red-600">âœ—</span>
                )}
              </label>
            ))}
          </div>
          
          {showResult && (
            <div className={`p-4 rounded-lg mb-4 ${selectedAnswer === question.answer ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
              <p className={`font-medium mb-2 ${selectedAnswer === question.answer ? 'text-green-800' : 'text-red-800'}`}>
                {selectedAnswer === question.answer ? 'âœ… å›ç­”æ­£ç¢ºï¼' : `âŒ å›ç­”éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ ${question.answer}`}
              </p>
              <p className="text-gray-700">{question.explanation}</p>
            </div>
          )}
          
          <div className="flex justify-end">
            {!showResult ? (
              <button
                onClick={submitAnswer}
                disabled={!selectedAnswer}
                className="px-6 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors"
              >
                æäº¤ç­”æ¡ˆ
              </button>
            ) : (
              <button
                onClick={nextQuestion}
                className="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors"
              >
                {currentQuestion < challengeQuestions.length - 1 ? 'ä¸‹ä¸€é¡Œ' : 'å®ŒæˆæŒ‘æˆ°'}
              </button>
            )}
          </div>
        </div>
      </div>
    );
  };

  // è£å‚™å•†åº—
  const renderShopView = () => (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold">ğŸ›’ ç…‰é‡‘å¸«è£å‚™å•†åº—</h2>
        <button
          onClick={() => setCurrentView('main')}
          className="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"
        >
          è¿”å›ä¸»é¸å–®
        </button>
      </div>
      
      <div className="grid gap-4">
        {Object.entries(equipmentShop).map(([itemName, itemData]) => (
          <div key={itemName} className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
            <div className="flex items-center justify-between">
              <div className="flex-1">
                <h3 className="font-medium mb-1">{itemName}</h3>
                <p className="text-sm text-gray-600 mb-2">{itemData.description}</p>
                <div className="flex items-center gap-4">
                  <span className="font-bold text-yellow-600">{itemData.price} é‡‘å¹£</span>
                  {player.equipment[itemName] && (
                    <span className="text-green-600 font-medium">âœ… å·²æ“æœ‰</span>
                  )}
                </div>
              </div>
              <button
                onClick={() => buyEquipment(itemName, itemData)}
                disabled={player.equipment[itemName] || player.coins < itemData.price}
                className="px-4 py-2 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-300 text-white rounded-lg transition-colors"
              >
                {player.equipment[itemName] ? 'å·²æ“æœ‰' : 'è³¼è²·'}
              </button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );

  // æˆå°±ç³»çµ±
  const renderAchievementsView = () => {
    const unlockedCount = Object.values(achievements).filter(a => a.unlocked).length;
    const totalCount = Object.keys(achievements).length;
    
    return (
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold">ğŸ† æˆå°±ç³»çµ±</h2>
            <p className="text-gray-600">å·²è§£é–ï¼š{unlockedCount}/{totalCount}</p>
          </div>
          <button
            onClick={() => setCurrentView('main')}
            className="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"
          >
            è¿”å›ä¸»é¸å–®
          </button>
        </div>
        
        <div className="grid gap-4">
          {Object.entries(achievements).map(([name, data]) => (
            <div key={name} className={`border rounded-lg p-4 ${data.unlocked ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200'}`}>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-2xl">{data.unlocked ? 'âœ…' : 'ğŸ”’'}</span>
                  <div>
                    <h3 className="font-medium">{name}</h3>
                    <p className="text-sm text-gray-600">{data.description}</p>
                  </div>
                </div>
                <span className="font-bold text-yellow-600">{data.reward} é‡‘å¹£</span>
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  };

  // å­¸ç¿’å ±å‘Š
  const renderReportView = () => (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-2xl font-bold">ğŸ“Š å­¸ç¿’å ±å‘Š</h2>
        <button
          onClick={() => setCurrentView('main')}
          className="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg"
        >
          è¿”å›ä¸»é¸å–®
        </button>
      </div>
      
      {/* ç¸½é«”è¡¨ç¾ */}
      <div className="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
        <h3 className="text-lg font-medium mb-4">ğŸ“ˆ ç¸½é«”è¡¨ç¾</h3>
        {player.total_questions > 0 ? (
          <div className="grid grid-cols-3 gap-4">
            <div className="text-center">
              <div className="text-2xl font-bold text-blue-600">{player.total_questions}</div>
              <div className="text-sm text-gray-600">ç­”é¡Œç¸½æ•¸</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-green-600">{player.correct_answers}</div>
              <div className="text-sm text-gray-600">æ­£ç¢ºç­”æ•¸</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-purple-600">
                {((player.correct_answers / player.total_questions) * 100).toFixed(1)}%
              </div>
              <div className="text-sm text-gray-600">æº–ç¢ºç‡</div>
            </div>
          </div>
        ) : (
          <p className="text-gray-500">é‚„æ²’æœ‰ç­”é¡Œè¨˜éŒ„ï¼Œé–‹å§‹æŒ‘æˆ°å§ï¼</p>
        )}
      </div>
      
      {/* èª²é¡Œå®Œæˆåº¦ */}
      <div className="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
        <h3 className="text-lg font-medium mb-4">ğŸ“š èª²é¡Œå®Œæˆåº¦</h3>
        <div className="space-y-3">
          {Object.entries(topics).map(([topicId, topic]) => {
            const percentage = (topic.progress / topic.total) * 100;
            return (
              <div key={topicId}>
                <div className="flex items-center justify-between mb-1">
                  <span className="flex items-center gap-2">
                    <span>{topic.icon}</span>
                    <span className="font-medium">{topic.name}</span>
                  </span>
                  <span className="text-sm text-gray-600">{percentage.toFixed(0)}%</span>
                </div>
                <ProgressBar current={topic.progress} max={topic.total} />
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-100">
      {/* æ¨™é¡Œ */}
      <div className="bg-gradient-to-r from-blue-600 to-purple-700 text-white p-6 shadow-lg">
        <div className="max-w-4xl mx-auto">
          <h1 className="text-3xl font-bold text-center mb-2">ğŸ§ª DSEåŒ–å­¸å¾é€”ï¼šå…ƒç´ ç…‰é‡‘å¸«</h1>
          <p className="text-center text-blue-100">èåˆé¦™æ¸¯DSEåŒ–å­¸èª²ç¨‹èˆ‡è§’è‰²æ‰®æ¼”éŠæˆ²çš„æ²‰æµ¸å¼å­¸ç¿’é«”é©—</p>
        </div>
      </div>

      {/* ä¸»è¦å…§å®¹ */}
      <div className="max-w-4xl mx-auto p-6">
        {/* è¨Šæ¯æç¤º */}
        {message && (
          <div className="mb-4 p-4 bg-green-100 border border-green-200 text-green-800 rounded-lg">
            {message}
          </div>
        )}

        {/* æ ¹æ“šç•¶å‰è¦–åœ–æ¸²æŸ“ä¸åŒå…§å®¹ */}
        {currentView === 'main' && renderMainView()}
        {currentView === 'topics' && renderTopicsView()}
        {currentView === 'challenge' && renderChallengeView()}
        {currentView === 'shop' && renderShopView()}
        {currentView === 'achievements' && renderAchievementsView()}
        {currentView === 'report' && renderReportView()}
      </div>
    </div>
  );
};

export default ChemistryRPG;
