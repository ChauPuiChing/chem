<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE化學征途：元素煉金師</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 遊戲容器 -->
    <div id="game-container">
        <!-- 標題 -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-700 text-white p-6 shadow-lg">
            <div class="max-w-4xl mx-auto text-center">
                <h1 class="text-4xl font-bold mb-2">🧪 DSE化學征途：元素煉金師</h1>
                <p class="text-blue-100">融合香港DSE化學課程與角色扮演遊戲的沉浸式學習體驗</p>
            </div>
        </div>

        <!-- 主要內容區 -->
        <div class="max-w-4xl mx-auto p-6">
            <!-- 訊息提示 -->
            <div id="message-container" class="hidden mb-4 p-4 bg-green-100 border border-green-200 text-green-800 rounded-lg"></div>

            <!-- 主選單 -->
            <div id="main-view" class="animate-fade-in">
                <!-- 玩家狀態卡片 -->
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-lg shadow-lg mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 id="player-name" class="text-2xl font-bold">見習化學家</h2>
                            <p id="player-title" class="text-blue-100">化學學徒</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xl">👑</span>
                                <span id="player-level" class="text-xl font-bold">等級 1</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-lg">🪙</span>
                                <span id="player-coins">50 金幣</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="text-center">
                            <div class="flex items-center justify-center gap-1 mb-1">
                                <span>⚔️</span>
                                <span class="font-medium">攻擊力</span>
                            </div>
                            <span id="player-attack" class="text-lg font-bold">10</span>
                        </div>
                        <div class="text-center">
                            <div class="flex items-center justify-center gap-1 mb-1">
                                <span>🛡️</span>
                                <span class="font-medium">防禦力</span>
                            </div>
                            <span id="player-defense" class="text-lg font-bold">5</span>
                        </div>
                        <div class="text-center">
                            <div class="flex items-center justify-center gap-1 mb-1">
                                <span>🎯</span>
                                <span class="font-medium">精度</span>
                            </div>
                            <span id="player-accuracy" class="text-lg font-bold">60%</span>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>經驗值</span>
                            <span id="exp-display">0/100</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-2">
                            <div id="exp-bar" class="bg-yellow-400 h-2 rounded-full progress-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="accuracy-display" class="mt-4 text-center text-blue-100 hidden">
                        答題準確率: <span id="accuracy-rate">0%</span> (<span id="correct-total">0/0</span>)
                    </div>
                </div>

                <!-- 主選單按鈕 -->
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="showTopics()" class="flex items-center justify-between p-4 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors card-hover">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">📚</span>
                            <span class="font-medium">課題挑戰</span>
                        </div>
                        <span class="text-xl">➤</span>
                    </button>

                    <button onclick="showBosses()" class="flex items-center justify-between p-4 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors card-hover">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">👹</span>
                            <span class="font-medium">魔王挑戰</span>
                        </div>
                        <span class="text-xl">➤</span>
                    </button>

                    <button onclick="showShop()" class="flex items-center justify-between p-4 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors card-hover">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">🛒</span>
                            <span class="font-medium">裝備商店</span>
                              </div>
                        <span class="text-xl">➤</span>
                    </button>
                        
                     <button onclick="showAchievements()" class="flex items-center justify-between p-4 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition-colors card-hover">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">🏆</span>
                            <span class="font-medium">成就系統</span>
                              </div>
                        <span class="text-xl">➤</span>
                    </button>
                   
                            <button onclick="showSkillTree()" class="flex items-center justify-between p-4 bg-green-400 hover:bg-green-500 text-white rounded-lg transition-colors card-hover">
                        <div class="flex items-center gap-3">
                         <span class="text-2xl">🌳</span>
                         <span class="font-medium">技能樹</span>
                        </div>
                         <span class="text-xl">➤</span>
                    </button>

                    <button onclick="showReport()" class="flex items-center justify-between p-4 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors card-hover">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">📊</span>
                            <span class="font-medium">學習報告</span>
                        </div>
                        <span class="text-xl">➤</span>
                    </button>

                    <button onclick="saveGame()" class="flex items-center justify-between p-4 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors card-hover">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">💾</span>
                            <span class="font-medium">儲存遊戲</span>
                        </div>
                        <span class="text-xl">➤</span>
                    </button>
                </div>
            </div>

            <!-- 課題選單 -->
            <div id="topics-view" class="hidden animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold gradient-text">🎯 DSE化學課題挑戰</h2>
                    <button onclick="showMain()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">返回主選單</button>
                </div>
                <div id="topics-grid" class="grid gap-4"></div>
            </div>

            <!-- 挑戰界面 -->
            <div id="challenge-view" class="hidden animate-fade-in">
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="flex items-center justify-between">
                        <h2 id="challenge-title" class="text-xl font-bold"></h2>
                        <span id="question-counter" class="text-sm text-gray-600"></span>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                        <div class="mb-4">
                            <div class="flex items-center gap-2 mb-2">
                                <span id="question-topic" class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded"></span>
                                <span id="question-difficulty" class="text-sm bg-yellow-100 text-yellow-800 px-2 py-1 rounded"></span>
                            </div>
                            <h3 id="question-text" class="text-lg font-medium mb-4"></h3>
                        </div>

                        <div id="options-container" class="space-y-3 mb-6"></div>

                        <div id="result-container" class="hidden mb-4"></div>

                        <div class="flex justify-end">
                            <button id="submit-btn" onclick="submitAnswer()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors">提交答案</button>
                        </div>
                    </div>
                </div>
            </div>
<!-- 新增技能樹視圖 -->
<div id="skill-tree-view" class="hidden animate-fade-in max-w-2xl mx-auto p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold gradient-text">🌳 技能樹</h2>
        <button onclick="showMain()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">返回主選單</button>
    </div>
    <div id="skill-tree-grid" class="grid grid-cols-1 gap-4"></div>
    <div class="mt-4 text-right text-blue-800 text-lg font-bold">
        技能點：<span id="player-skill-points"></span>
    </div>
</div>
            <!-- 裝備商店 -->
            <div id="shop-view" class="hidden animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold gradient-text">🛒 煉金師裝備商店</h2>
                    <button onclick="showMain()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">返回主選單</button>
                </div>
                <div id="shop-grid" class="grid gap-4"></div>
            </div>

            <!-- 成就系統 -->
            <div id="achievements-view" class="hidden animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold gradient-text">🏆 成就系統</h2>
                        <p id="achievement-progress" class="text-gray-600">已解鎖：0/7</p>
                    </div>
                    <button onclick="showMain()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">返回主選單</button>
                </div>
                <div id="achievements-grid" class="grid gap-4"></div>
            </div>

            <!-- 學習報告 -->
            <div id="report-view" class="hidden animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold gradient-text">📊 學習報告</h2>
                    <button onclick="showMain()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">返回主選單</button>
                </div>

                <!-- 總體表現 -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6">
                    <h3 class="text-lg font-medium mb-4">📈 總體表現</h3>
                    <div id="overall-stats" class="grid grid-cols-3 gap-4">
                        <div class="text-center">
                            <div id="total-questions" class="text-2xl font-bold text-blue-600">0</div>
                            <div class="text-sm text-gray-600">答題總數</div>
                        </div>
                        <div class="text-center">
                            <div id="correct-answers" class="text-2xl font-bold text-green-600">0</div>
                            <div class="text-sm text-gray-600">正確答數</div>
                        </div>
                        <div class="text-center">
                            <div id="accuracy-percentage" class="text-2xl font-bold text-purple-600">0%</div>
                            <div class="text-sm text-gray-600">準確率</div>
                        </div>
                    </div>
                </div>

                <!-- 課題完成度 -->
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h3 class="text-lg font-medium mb-4">📚 課題完成度</h3>
                    <div id="topic-progress" class="space-y-3"></div>
                </div>
            </div>

            <!-- 魔王挑戰 -->
<div id="bosses-view" class="hidden animate-fade-in">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold gradient-text">👹 知識魔王挑戰</h2>
        <button onclick="showMain()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">返回主選單</button>
    </div>
    <div id="boss-list"></div>
</div>
            
<!-- 魔王挑戰介面 -->
<div id="boss-challenge-view" class="hidden animate-fade-in">
    <div class="max-w-2xl mx-auto space-y-6">
        <div class="flex items-center justify-between">
            <h2 id="boss-name" class="text-2xl font-bold"></h2>
            <span id="boss-hp-display" class="text-lg text-red-600"></span>
        </div>
        <p id="boss-description" class="text-gray-700 mb-4"></p>
        <div id="boss-question-block"></div>
        <div id="boss-result-block" class="hidden"></div>
        <div class="flex justify-end">
            <button id="boss-submit-btn" class="px-6 py-2 bg-blue-500 text-white rounded-lg transition-colors">提交答案</button>
        </div>
    </div>
</div>

    <script>
        // 遊戲數據
        let gameData = {
            player: {
                name: "見習化學家",
                level: 1,
                exp: 0,
                exp_to_next: 100,
                coins: 50,
                attack: 10,
                defense: 5,
                accuracy: 60,
                skill_points: 0,
                title: "化學學徒",
                skills: {
  "理論化學": { unlocked: false, desc: "提升理論題得分 +5%", cost: 1 },
  "實驗技巧": { unlocked: false, desc: "滴定準確度 +5%", cost: 1 },
  "無機化學": { unlocked: false, desc: "氧化還原題目正確率 +5%", cost: 2 }
},

                equipment: {},
                achievements: [],
                topics_completed: [],
                total_questions: 0,
                correct_answers: 0
            },
            topics: {
                "1": { name: "地球資源", icon: "🌍", progress: 0, total: 5 },
                "2": { name: "微觀世界", icon: "⚛️", progress: 0, total: 5 },
                "3": { name: "金屬", icon: "💎", progress: 0, total: 5 },
                "4": { name: "酸鹼鹽", icon: "🧪", progress: 0, total: 5 },
                "5": { name: "化石燃料", icon: "⛽", progress: 0, total: 5 },
                "6": { name: "氧化還原反應", icon: "🔋", progress: 0, total: 5 },
                "7": { name: "化學反應與能量", icon: "⚡", progress: 0, total: 5 },
                "8": { name: "反應速率與平衡", icon: "⚖️", progress: 0, total: 5 },
                "9": { name: "化學世界中的規律", icon: "📊", progress: 0, total: 5 }
            },
            achievements: {
                "電解大師": { description: "完成10個電解相關題目", reward: 50, unlocked: false },
                "計算達人": { description: "連續10題計算全對", reward: 100, unlocked: false },
                "實驗零失誤": { description: "完成所有實驗模擬無錯誤", reward: 200, unlocked: false },
                "百題斬": { description: "回答100道題目", reward: 150, unlocked: false },
                "知識收集者": { description: "完成5個課題", reward: 300, unlocked: false },
                "魔王終結者": { description: "擊敗所有知識魔王", reward: 500, unlocked: false },
                "完美主義者": { description: "答題準確率達到90%", reward: 250, unlocked: false }
            }
        };

        // 題庫
        const questionBank = {
            "1": [
                {
                    question: "鐵礦石主要用哪種方法提取鐵？",
                    options: ["A. 電解", "B. 碳還原", "C. 熱分解", "D. 物理分離"],
                    answer: "B",
                    explanation: "鐵礦石通常使用碳還原法提取鐵，在高溫下用一氧化碳還原氧化鐵。",
                    topic: "金屬提取",
                    difficulty: 2
                },
                {
                    question: "以下哪種氣體會導致溫室效應？",
                    options: ["A. 氧氣", "B. 氮氣", "C. 二氧化碳", "D. 氫氣"],
                    answer: "C",
                    explanation: "二氧化碳是主要的溫室氣體之一，能吸收地面輻射的紅外線。",
                    topic: "環境化學",
                    difficulty: 1
                },
                {
                    question: "石灰石的主要成分是什麼？",
                    options: ["A. CaO", "B. CaCO₃", "C. Ca(OH)₂", "D. CaSO₄"],
                    answer: "B",
                    explanation: "石灰石的主要成分是碳酸鈣(CaCO₃)。",
                    topic: "礦物",
                    difficulty: 1
                },
                {
                    question: "煤炭燃燒會產生哪種有害氣體？",
                    options: ["A. O₂", "B. N₂", "C. SO₂", "D. H₂"],
                    answer: "C",
                    explanation: "煤炭含有硫化合物，燃燒時會產生二氧化硫，導致酸雨。",
                    topic: "燃料化學",
                    difficulty: 2
                },
                {
                    question: "海水中含量最多的鹽類是？",
                    options: ["A. NaCl", "B. MgCl₂", "C. CaCl₂", "D. KCl"],
                    answer: "A",
                    explanation: "海水中含量最多的鹽類是氯化鈉(NaCl)，約佔總鹽分的77%。",
                    topic: "天然資源",
                    difficulty: 2
                }
            ],
            "2": [
                {
                    question: "原子核由什麼粒子組成？",
                    options: ["A. 質子和電子", "B. 質子和中子", "C. 中子和電子", "D. 只有質子"],
                    answer: "B",
                    explanation: "原子核由質子和中子組成，電子在核外運動。",
                    topic: "原子結構",
                    difficulty: 1
                },
                {
                    question: "碳-12原子的質量數是多少？",
                    options: ["A. 6", "B. 12", "C. 18", "D. 24"],
                    answer: "B",
                    explanation: "質量數等於質子數加中子數，碳-12有6個質子和6個中子。",
                    topic: "原子質量",
                    difficulty: 2
                },
                {
                    question: "電子在原子中的排列遵循什麼原理？",
                    options: ["A. 能量最高原理", "B. 能量最低原理", "C. 隨機排列", "D. 密度最大原理"],
                    answer: "B",
                    explanation: "電子在原子中會優先佔據能量較低的軌域，這是能量最低原理。",
                    topic: "電子結構",
                    difficulty: 2
                },
                {
                    question: "同位素是指具有相同什麼數目的原子？",
                    options: ["A. 質量數", "B. 中子數", "C. 質子數", "D. 電子數"],
                    answer: "C",
                    explanation: "同位素是指質子數相同但中子數不同的原子。",
                    topic: "同位素",
                    difficulty: 2
                },
                {
                    question: "原子的化學性質主要由什麼決定？",
                    options: ["A. 質子數", "B. 中子數", "C. 最外層電子", "D. 原子質量"],
                    answer: "C",
                    explanation: "原子的化學性質主要由最外層電子數決定。",
                    topic: "化學性質",
                    difficulty: 2
                }
            ],
            "3": [
                {
                    question: "金屬具有光澤是因為？",
                    options: ["A. 電子雲反射光線", "B. 原子振動", "C. 離子排列", "D. 化學反應"],
                    answer: "A",
                    explanation: "金屬的自由電子能有效反射光線，因此具有金屬光澤。",
                    topic: "金屬性質",
                    difficulty: 2
                },
                {
                    question: "鋁在空氣中不易腐蝕是因為？",
                    options: ["A. 鋁很穩定", "B. 表面形成氧化膜", "C. 鋁不活潑", "D. 鋁不導電"],
                    answer: "B",
                    explanation: "鋁表面會形成緻密的氧化鋁薄膜，阻止進一步氧化。",
                    topic: "金屬腐蝕",
                    difficulty: 2
                },
                {
                    question: "金屬的活性順序中，最活潑的是？",
                    options: ["A. 鐵", "B. 鋅", "C. 鉀", "D. 銅"],
                    answer: "C",
                    explanation: "在金屬活性順序中，鉀是最活潑的金屬之一。",
                    topic: "金屬活性",
                    difficulty: 2
                },
                {
                    question: "合金比純金屬更堅硬是因為？",
                    options: ["A. 質量更大", "B. 原子排列被打亂", "C. 密度更高", "D. 溫度更高"],
                    answer: "B",
                    explanation: "合金中不同大小的原子打亂了金屬的規則排列，使其更堅硬。",
                    topic: "合金",
                    difficulty: 2
                },
                {
                    question: "電鍍的原理是？",
                    options: ["A. 物理沉積", "B. 電解", "C. 化學反應", "D. 熱處理"],
                    answer: "B",
                    explanation: "電鍍是利用電解原理，在金屬表面沉積另一種金屬。",
                    topic: "電鍍",
                    difficulty: 2
                }
            ],
            "4": [
                {
                    question: "以下哪種物質是強酸？",
                    options: ["A. 醋酸", "B. 硫酸", "C. 碳酸", "D. 硼酸"],
                    answer: "B",
                    explanation: "硫酸是常見的強酸，在水中完全電離。",
                    topic: "酸的強度",
                    difficulty: 1
                },
                {
                    question: "pH值為7的溶液是？",
                    options: ["A. 酸性", "B. 鹼性", "C. 中性", "D. 無法確定"],
                    answer: "C",
                    explanation: "pH=7表示[H⁺]=[OH⁻]，溶液呈中性。",
                    topic: "pH值",
                    difficulty: 1
                },
                {
                    question: "氫氧化鈉的化學式是？",
                    options: ["A. NaOH", "B. Na₂O", "C. NaCl", "D. Na₂SO₄"],
                    answer: "A",
                    explanation: "氫氧化鈉的化學式是NaOH，是常見的強鹼。",
                    topic: "鹼類",
                    difficulty: 1
                },
                {
                    question: "鹽酸與大理石反應會產生什麼氣體？",
                    options: ["A. 氫氣", "B. 氧氣", "C. 二氧化碳", "D. 氮氣"],
                    answer: "C",
                    explanation: "鹽酸與碳酸鈣(大理石)反應產生二氧化碳氣體。",
                    topic: "酸鹼反應",
                    difficulty: 2
                },
                {
                    question: "滴定實驗中，指示劑的作用是？",
                    options: ["A. 加速反應", "B. 顯示終點", "C. 提供氫離子", "D. 中和溶液"],
                    answer: "B",
                    explanation: "指示劑在滴定中用來顯示反應的終點。",
                    topic: "滴定",
                    difficulty: 2
                }
            ]
        };

        // 魔王題庫示例
const bosses = [
    {
        id: "boss1",
        name: "硫磺魔王",
        icon: "👹",
        description: "融合酸鹼、金屬、環境化學的終極考驗。",
        hp: 3,
        questions: [
            {
                question: "硫酸與鐵反應後，產物是？",
                options: ["A. FeSO₄ + H₂", "B. Fe₂(SO₄)₃ + H₂", "C. FeSO₄ + SO₂ + H₂O", "D. FeO + H₂SO₄"],
                answer: "A",
                explanation: "鐵與稀硫酸反應生成硫酸亞鐵和氫氣。"
            },
            {
                question: "下列何者屬於溫室氣體？",
                options: ["A. O₂", "B. CO₂", "C. N₂", "D. H₂"],
                answer: "B",
                explanation: "CO₂（二氧化碳）是主要的溫室氣體之一。"
            },
            {
                question: "金屬腐蝕的主要原因是？",
                options: ["A. 金屬與水反應", "B. 金屬與氧氣反應", "C. 金屬與氫氣反應", "D. 金屬與氯氣反應"],
                answer: "B",
                explanation: "金屬與氧氣反應形成氧化層，導致腐蝕。"
            }
        ],
        reward: { exp: 200, coins: 100, achievement: "魔王終結者" }
    },
    {
    id: "boss2",
    name: "模糊之影",
    icon: "👻",
    description: "考驗基礎知識與細心審題能力。",
    hp: 4,
    questions: [
        {
            question: "下列哪項是強鹼？",
            options: ["A. HCl", "B. NaOH", "C. H2SO4", "D. CH3COOH"],
            answer: "B",
            explanation: "NaOH（氫氧化鈉）是強鹼。"
        },
        {
            question: "下列哪個物質屬於金屬？",
            options: ["A. 硫", "B. 氧", "C. 鋅", "D. 氯"],
            answer: "C",
            explanation: "鋅屬於金屬元素。"
        },
        {
            question: "1摩爾水分子含有多少個分子？",
            options: ["A. 6.02×10^23", "B. 1", "C. 18", "D. 1000"],
            answer: "A",
            explanation: "1摩爾任何物質都含有阿伏伽德羅常數個微粒。"
        },
        {
            question: "下列哪項為中性溶液的pH值？",
            options: ["A. 5", "B. 7", "C. 9", "D. 3"],
            answer: "B",
            explanation: "pH=7為中性。"
        }
    ],
    reward: { exp: 250, coins: 150, achievement: "" }
}
    // 可以持續新增更多魔王
];

// Boss 挑戰狀態
let currentBoss = null;
let bossQuestionIndex = 0;
let bossHP = 0;

// 顯示 Boss 列表
function renderBossList() {
    const container = document.getElementById('boss-list');
    container.innerHTML = bosses.map(boss => `
        <div class="mb-4 p-4 bg-white border rounded shadow flex items-center justify-between">
            <div>
                <span class="text-3xl mr-2">${boss.icon}</span>
                <b>${boss.name}</b>
                <p class="text-gray-600">${boss.description}</p>
            </div>
            <button onclick="startBossChallenge('${boss.id}')" class="bg-red-500 text-white px-4 py-2 rounded">挑戰</button>
        </div>
    `).join('');
}

// 覆寫 showBosses
function showBosses() {
    hideAllViews();
    document.getElementById('bosses-view').classList.remove('hidden');
    renderBossList();
}

// 啟動 Boss 挑戰
function startBossChallenge(bossId) {
    currentBoss = bosses.find(b => b.id === bossId);
    bossQuestionIndex = 0;
    bossHP = currentBoss.hp;
    hideAllViews();
    document.getElementById('boss-challenge-view').classList.remove('hidden');
    document.getElementById('boss-name').textContent = `${currentBoss.icon} ${currentBoss.name}`;
    document.getElementById('boss-description').textContent = currentBoss.description;
    updateBossHP();
    renderBossQuestion();
}

// 顯示 Boss HP
function updateBossHP() {
    document.getElementById('boss-hp-display').textContent = `HP: ${bossHP}/${currentBoss.hp}`;
}

// 顯示 Boss 題目
function renderBossQuestion() {
    const q = currentBoss.questions[bossQuestionIndex];
    const block = document.getElementById('boss-question-block');
    block.innerHTML = `
        <div class="mb-2 font-medium">${q.question}</div>
        <div>
            ${q.options.map(opt => `
                <label class="block mb-2">
                    <input type="radio" name="boss-answer" value="${opt.charAt(0)}"> ${opt}
                </label>
            `).join('')}
        </div>
    `;
    document.getElementById('boss-result-block').classList.add('hidden');
    document.getElementById('boss-submit-btn').onclick = submitBossAnswer;
}

// 提交 Boss 答案
function submitBossAnswer() {
    const q = currentBoss.questions[bossQuestionIndex];
    const selected = document.querySelector('input[name="boss-answer"]:checked');
    if (!selected) return;
    const isCorrect = selected.value === q.answer;

    // 回饋
    const resultBlock = document.getElementById('boss-result-block');
    resultBlock.classList.remove('hidden');
    resultBlock.innerHTML = isCorrect 
        ? `<div class="text-green-700">✅ 正確！${q.explanation}</div>`
        : `<div class="text-red-700">❌ 錯誤！正確答案是 ${q.answer}。${q.explanation}</div>`;

    if (isCorrect) bossHP--;
    updateBossHP();

    // 下一題或結算
    setTimeout(() => {
        bossQuestionIndex++;
        if (bossHP === 0) {
            finishBossChallenge(true);
        } else if (bossQuestionIndex >= currentBoss.questions.length) {
            finishBossChallenge(false);
        } else {
            renderBossQuestion();
        }
    }, 1200);
}

// 結算 Boss 挑戰
function finishBossChallenge(victory) {
    const reward = currentBoss.reward;
    let msg = '';
    if (victory) {
        gameData.player.exp += reward.exp;
        gameData.player.coins += reward.coins;
        if (gameData.achievements[reward.achievement]) {
            gameData.achievements[reward.achievement].unlocked = true;
        }
        msg = `🎉 你擊敗了${currentBoss.name}！獲得${reward.exp}經驗和${reward.coins}金幣。`;
    } else {
        msg = '😢 挑戰失敗，下次再來！';
    }
    showMessage(msg);
    checkLevelUp();
    checkAchievements();
    showBosses();
}
        
        // 裝備商店
        const equipmentShop = {
            "精密滴定管": { price: 100, attack: 8, accuracy: 5, description: "+8攻擊力, +5%實驗精度" },
            "高效本生燈": { price: 150, attack: 12, description: "+12攻擊力, 加速反應任務" },
            "電解大師手套": { price: 200, attack: 15, defense: 10, description: "+15攻擊力, +10防禦力" },
            "化學典籍": { price: 120, defense: 10, accuracy: 8, description: "+10防禦力, 提升理論題得分" },
            "護目鏡": { price: 80, defense: 5, accuracy: 10, description: "+5防禦力, +10%實驗精度" },
            "計算神器": { price: 250, attack: 20, accuracy: 15, description: "+20攻擊力, +15%計算準確度" },
            "速記卷軸": { price: 120, description: "縮短答題時間，理論題答題速度+10%", special: "quick-answer" },
            "靈感藥劑": { price: 200, description: "遇到難題時可顯示提示", special: "hint" }
        };

        // 挑戰相關變數
        let currentChallenge = null;
        let challengeQuestions = [];
        let currentQuestion = 0;
        let selectedAnswer = '';
        let showResult = false;
        let challengeResults = { correct: 0, total: 0 };

        // 初始化遊戲
        function initGame() {
            loadGame();
            updatePlayerDisplay();
            showMain();
        }

        // 載入遊戲數據
        function loadGame() {
            const savedGame = localStorage.getItem('dse-chemistry-rpg');
            if (savedGame) {
                try {
                    const data = JSON.parse(savedGame);
                    gameData = { ...gameData, ...data };
                } catch (e) {
                    console.error('載入遊戲失敗:', e);
                }
            }
        }

        // 儲存遊戲
        function saveGame() {
            const saveData = {
                ...gameData,
                lastSave: new Date().toISOString()
            };
            localStorage.setItem('dse-chemistry-rpg', JSON.stringify(saveData));
            showMessage('✅ 遊戲進度已儲存！');
        }

        // 顯示訊息
        function showMessage(message) {
            const container = document.getElementById('message-container');
            container.textContent = message;
            container.classList.remove('hidden');
            setTimeout(() => {
                container.classList.add('hidden');
            }, 3000);
        }

        // 更新玩家顯示
        function updatePlayerDisplay() {
            const player = gameData.player;
            document.getElementById('player-name').textContent = player.name;
            document.getElementById('player-title').textContent = player.title;
            document.getElementById('player-level').textContent = `等級 ${player.level}`;
            document.getElementById('player-coins').textContent = `${player.coins} 金幣`;
            document.getElementById('player-attack').textContent = player.attack;
            document.getElementById('player-defense').textContent = player.defense;
            document.getElementById('player-accuracy').textContent = `${player.accuracy}%`;
            document.getElementById('exp-display').textContent = `${player.exp}/${player.exp_to_next}`;
            
            const expPercentage = (player.exp / player.exp_to_next) * 100;
            document.getElementById('exp-bar').style.width = `${expPercentage}%`;

            if (player.total_questions > 0) {
                const accuracy = ((player.correct_answers / player.total_questions) * 100).toFixed(1);
                document.getElementById('accuracy-rate').textContent = `${accuracy}%`;
                document.getElementById('correct-total').textContent = `${player.correct_answers}/${player.total_questions}`;
                document.getElementById('accuracy-display').classList.remove('hidden');
            }
        }

        // 升級檢查
        function checkLevelUp() {
            let player = gameData.player;
            while (player.exp >= player.exp_to_next) {
                player.exp -= player.exp_to_next;
                player.level += 1;
                player.exp_to_next = Math.floor(player.exp_to_next * 1.5);
                player.attack += 5;
                player.defense += 3;
                player.accuracy += 2;
                player.skill_points += 1;

                // 更新稱號
                if (player.level >= 20) player.title = "傳奇煉金師";
                else if (player.level >= 15) player.title = "元素掌控者";
                else if (player.level >= 10) player.title = "傑出分析者";
                else if (player.level >= 5) player.title = "合格實驗員";

                showMessage(`🎉 恭喜升級到 ${player.level} 級！獲得技能點 +1`);
            }
            updatePlayerDisplay();
        }

        // 檢查成就
        function checkAchievements() {
            const player = gameData.player;
            const achievements = gameData.achievements;
            let newUnlocked = [];

            // 百題斬
            if (player.total_questions >= 100 && !achievements['百題斬'].unlocked) {
                achievements['百題斬'].unlocked = true;
                newUnlocked.push('百題斬');
            }

            // 完美主義者
            if (player.total_questions >= 20 && 
                (player.correct_answers / player.total_questions) >= 0.9 &&
                !achievements['完美主義者'].unlocked) {
                achievements['完美主義者'].unlocked = true;
                newUnlocked.push('完美主義者');
            }

            // 處理新成就獎勵
            if (newUnlocked.length > 0) {
                let totalReward = 0;
                newUnlocked.forEach(achievement => {
                    totalReward += achievements[achievement].reward;
                });
                player.coins += totalReward;
                showMessage(`🏆 獲得成就：${newUnlocked.join('、')}！獎勵 ${totalReward} 金幣`);
                updatePlayerDisplay();
            }
        }

        // 視圖切換
        function hideAllViews() {
            const views = ['main-view', 'topics-view', 'challenge-view', 'shop-view', 'achievements-view', 'report-view', 'bosses-view'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
        }

        function showMain() {
            hideAllViews();
            document.getElementById('main-view').classList.remove('hidden');
            updatePlayerDisplay();
        }

        function showTopics() {
            hideAllViews();
            document.getElementById('topics-view').classList.remove('hidden');
            renderTopics();
        }

        function showBosses() {
            hideAllViews();
            document.getElementById('bosses-view').classList.remove('hidden');
            renderBossList();
        }

        function showShop() {
            hideAllViews();
            document.getElementById('shop-view').classList.remove('hidden');
            renderShop();
        }

        function showAchievements() {
            hideAllViews();
            document.getElementById('achievements-view').classList.remove('hidden');
            renderAchievements();
        }

        function showReport() {
            hideAllViews();
            document.getElementById('report-view').classList.remove('hidden');
            renderReport();
        }

        // 渲染課題
        function renderTopics() {
            const grid = document.getElementById('topics-grid');
            grid.innerHTML = '';

            Object.entries(gameData.topics).forEach(([topicId, topic]) => {
                const progress = (topic.progress / topic.total) * 100;
                const isComplete = topic.progress >= topic.total;
                
                const topicCard = document.createElement('div');
                topicCard.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm card-hover';
                topicCard.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${topic.icon}</span>
                            <div>
                                <h3 class="font-medium">${topic.name}</h3>
                                <p class="text-sm text-gray-600">
                                    進度: ${topic.progress}/${topic.total}
                                    ${isComplete ? ' ✅已完成' : ''}
                                </p>
                            </div>
                        </div>
                        <button onclick="startTopicChallenge('${topicId}')" 
                                ${!questionBank[topicId] ? 'disabled' : ''}
                                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-300 text-white rounded-lg transition-colors">
                            開始挑戰
                        </button>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full progress-bar" style="width: ${progress}%"></div>
                    </div>
                `;
                grid.appendChild(topicCard);
            });
        }

        // 開始課題挑戰
        function startTopicChallenge(topicId) {
            const questions = questionBank[topicId] || [];
            if (questions.length === 0) {
                showMessage('❌ 該課題暫未開放');
                return;
            }

            challengeQuestions = questions;
            currentChallenge = topicId;
            currentQuestion = 0;
            selectedAnswer = '';
            showResult = false;
            challengeResults = { correct: 0, total: questions.length };

            hideAllViews();
            document.getElementById('challenge-view').classList.remove('hidden');
            displayQuestion();
        }

        // 顯示題目
        function displayQuestion() {
            const question = challengeQuestions[currentQuestion];
            const topic = gameData.topics[currentChallenge];

            document.getElementById('challenge-title').textContent = `${topic.icon} ${topic.name}`;
            document.getElementById('question-counter').textContent = `${currentQuestion + 1}/${challengeQuestions.length}`;
            document.getElementById('question-topic').textContent = question.topic;
            document.getElementById('question-difficulty').textContent = `難度: ${'⭐'.repeat(question.difficulty)}`;
            document.getElementById('question-text').textContent = question.question;

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';

            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('label');
                optionDiv.className = 'flex items-center space-x-3 cursor-pointer p-3 border border-gray-200 rounded-lg hover:bg-gray-50';
                optionDiv.innerHTML = `
                    <input type="radio" name="answer" value="${option.charAt(0)}" 
                           onchange="selectAnswer('${option.charAt(0)}')"
                           class="w-4 h-4 text-blue-600">
                    <span class="flex-1">${option}</span>
                `;
                optionsContainer.appendChild(optionDiv);
            });

            document.getElementById('result-container').classList.add('hidden');
            document.getElementById('submit-btn').textContent = '提交答案';
            document.getElementById('submit-btn').onclick = submitAnswer;
            document.getElementById('submit-btn').disabled = true;
        }

        // 選擇答案
        function selectAnswer(answer) {
            selectedAnswer = answer;
            document.getElementById('submit-btn').disabled = false;
        }

        // 提交答案
        function submitAnswer() {
            if (!selectedAnswer) return;

            const question = challengeQuestions[currentQuestion];
            const isCorrect = selectedAnswer === question.answer;
            const player = gameData.player;

            player.total_questions += 1;

            if (isCorrect) {
                player.correct_answers += 1;
                const expGain = question.difficulty * 10;
                const coinGain = question.difficulty * 2;
                player.exp += expGain;
                player.coins += coinGain;
                challengeResults.correct += 1;
            }

            checkLevelUp();
            checkAchievements();

            // 顯示結果
            const resultContainer = document.getElementById('result-container');
            resultContainer.className = isCorrect 
                ? 'p-4 rounded-lg mb-4 bg-green-50 border border-green-200'
                : 'p-4 rounded-lg mb-4 bg-red-50 border border-red-200';
            
            resultContainer.innerHTML = `
                <p class="font-medium mb-2 ${isCorrect ? 'text-green-800' : 'text-red-800'}">
                    ${isCorrect ? '✅ 回答正確！' : `❌ 回答錯誤！正確答案是 ${question.answer}`}
                </p>
                <p class="text-gray-700">${question.explanation}</p>
            `;
            resultContainer.classList.remove('hidden');

            // 更新按鈕
            document.getElementById('submit-btn').textContent = 
                currentQuestion < challengeQuestions.length - 1 ? '下一題' : '完成挑戰';
            document.getElementById('submit-btn').onclick = nextQuestion;

            // 禁用選項
            const radios = document.querySelectorAll('input[name="answer"]');
            radios.forEach(radio => radio.disabled = true);

            // 標記正確答案
            const options = document.querySelectorAll('#options-container label');
            options.forEach(option => {
                const radio = option.querySelector('input');
                const span = option.querySelector('span');
                if (radio.value === question.answer) {
                    span.className = 'flex-1 text-green-600 font-medium';
                    const checkmark = document.createElement('span');
                    checkmark.textContent = '✓';
                    checkmark.className = 'text-green-600';
                    option.appendChild(checkmark);
                } else if (radio.value === selectedAnswer && selectedAnswer !== question.answer) {
                    const crossmark = document.createElement('span');
                    crossmark.textContent = '✗';
                    crossmark.className = 'text-red-600';
                    option.appendChild(crossmark);
                }
            });
        }

        // 下一題
        function nextQuestion() {
            if (currentQuestion < challengeQuestions.length - 1) {
                currentQuestion++;
                selectedAnswer = '';
                displayQuestion();
            } else {
                // 挑戰完成
                const topicId = currentChallenge;
                const topic = gameData.topics[topicId];
                topic.progress = Math.min(topic.progress + challengeResults.correct, topic.total);

                const accuracy = (challengeResults.correct / challengeResults.total) * 100;
                if (accuracy >= 80) {
                    const bonusExp = 50;
                    const bonusCoins = 20;
                    gameData.player.exp += bonusExp;
                    gameData.player.coins += bonusCoins;
                    checkLevelUp();
                    showMessage(`🎉 優秀表現獎勵：${bonusExp} 經驗值，${bonusCoins} 金幣`);
                }

                showTopics();
            }
        }

        // 渲染商店
        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';

            Object.entries(equipmentShop).forEach(([itemName, itemData]) => {
                const owned = gameData.player.equipment[itemName];
                const canAfford = gameData.player.coins >= itemData.price;

                const itemCard = document.createElement('div');
                itemCard.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm card-hover';
                itemCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <h3 class="font-medium mb-1">${itemName}</h3>
                            <p class="text-sm text-gray-600 mb-2">${itemData.description}</p>
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-yellow-600">${itemData.price} 金幣</span>
                                ${owned ? '<span class="text-green-600 font-medium">✅ 已擁有</span>' : ''}
                            </div>
                        </div>
                        <button onclick="buyEquipment('${itemName}')" 
                                ${owned || !canAfford ? 'disabled' : ''}
                                class="px-4 py-2 bg-purple-500 hover:bg-purple-600 disabled:bg-gray-300 text-white rounded-lg transition-colors">
                            ${owned ? '已擁有' : '購買'}
                        </button>
                    </div>
                `;
                grid.appendChild(itemCard);
            });
        }

        // 購買裝備
        function buyEquipment(itemName) {
            const itemData = equipmentShop[itemName];
            const player = gameData.player;

            if (player.coins >= itemData.price && !player.equipment[itemName]) {
                player.coins -= itemData.price;
                player.equipment[itemName] = itemData;

                if (itemData.attack) player.attack += itemData.attack;
                if (itemData.defense) player.defense += itemData.defense;
                if (itemData.accuracy) player.accuracy += itemData.accuracy;

                showMessage(`✅ 成功購買 ${itemName}！`);
                updatePlayerDisplay();
                renderShop();
            } else if (player.equipment[itemName]) {
                showMessage('❌ 你已經擁有這件裝備了！');
            } else {
                showMessage('❌ 金幣不足！');
            }
        }

        // 渲染成就
        function renderAchievements() {
            const achievements = gameData.achievements;
            const unlockedCount = Object.values(achievements).filter(a => a.unlocked).length;
            const totalCount = Object.keys(achievements).length;

            document.getElementById('achievement-progress').textContent = `已解鎖：${unlockedCount}/${totalCount}`;

            const grid = document.getElementById('achievements-grid');
            grid.innerHTML = '';

            Object.entries(achievements).forEach(([name, data]) => {
                const achievementCard = document.createElement('div');
                achievementCard.className = data.unlocked 
                    ? 'border rounded-lg p-4 bg-yellow-50 border-yellow-200'
                    : 'border rounded-lg p-4 bg-gray-50 border-gray-200';
                
                achievementCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${data.unlocked ? '✅' : '🔒'}</span>
                            <div>
                                <h3 class="font-medium">${name}</h3>
                                <p class="text-sm text-gray-600">${data.description}</p>
                            </div>
                        </div>
                        <span class="font-bold text-yellow-600">${data.reward} 金幣</span>
                    </div>
                `;
                grid.appendChild(achievementCard);
            });
        }

        // 渲染學習報告
        function renderReport() {
            const player = gameData.player;

            if (player.total_questions > 0) {
                const accuracy = ((player.correct_answers / player.total_questions) * 100).toFixed(1);
                document.getElementById('total-questions').textContent = player.total_questions;
                document.getElementById('correct-answers').textContent = player.correct_answers;
                document.getElementById('accuracy-percentage').textContent = `${accuracy}%`;
            } else {
                document.getElementById('total-questions').textContent = '0';
                document.getElementById('correct-answers').textContent = '0';
                document.getElementById('accuracy-percentage').textContent = '0%';
            }

            // 課題進度
            const topicProgress = document.getElementById('topic-progress');
            topicProgress.innerHTML = '';

            Object.entries(gameData.topics).forEach(([topicId, topic]) => {
                const percentage = (topic.progress / topic.total) * 100;
                const progressDiv = document.createElement('div');
                progressDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-1">
                        <span class="flex items-center gap-2">
                            <span>${topic.icon}</span>
                            <span class="font-medium">${topic.name}</span>
                        </span>
                        <span class="text-sm text-gray-600">${percentage.toFixed(0)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full progress-bar" style="width: ${percentage}%"></div>
                    </div>
                `;
                topicProgress.appendChild(progressDiv);
            });
        }

        function showSkillTree() {
    hideAllViews();
    document.getElementById('skill-tree-view').classList.remove('hidden');
    renderSkillTree();
}

function renderSkillTree() {
    const grid = document.getElementById('skill-tree-grid');
    grid.innerHTML = '';
    const skills = gameData.player.skills;
    const skillPoints = gameData.player.skill_points;
    Object.entries(skills).forEach(([key, skill]) => {
        const btnDisabled = skill.unlocked || skillPoints < skill.cost;
        const card = document.createElement('div');
        card.className = 'bg-white border rounded-lg p-4 shadow-sm flex items-center justify-between';
        card.innerHTML = `
            <div>
                <div class="text-lg font-bold">${key}</div>
                <div class="text-gray-600">${skill.desc}</div>
            </div>
            <button ${btnDisabled ? 'disabled' : ''} onclick="unlockSkill('${key}')" class="px-4 py-2 rounded bg-green-500 hover:bg-green-600 text-white disabled:bg-gray-300">
                ${skill.unlocked ? '已解鎖' : `解鎖(-${skill.cost}點)`}
            </button>
        `;
        grid.appendChild(card);
    });
    document.getElementById('player-skill-points').textContent = gameData.player.skill_points;
}

function unlockSkill(name) {
    const skills = gameData.player.skills;
    if (!skills[name] || skills[name].unlocked) return;
    if (gameData.player.skill_points < skills[name].cost) return;
    skills[name].unlocked = true;
    gameData.player.skill_points -= skills[name].cost;
    showMessage(`已解鎖技能：「${name}」！`);
    renderSkillTree();
    saveGame();
}
        
        // 啟動遊戲
        window.onload = initGame;
    </script>
</body>
</html>
